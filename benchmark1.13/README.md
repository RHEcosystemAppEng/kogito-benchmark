# Kogito-benchmark on AWS
Requirements:
* Without Kogito operator 
* Git branch `kogito-1.13.0.Final`
* OpenShift on AWS with 4 worker nodes of c5.4xlarge machine
References:
* `https://github.com/mpaulgreen/kogito-benchmark/tree/openshift` (branch: openshift)
* Kogito version: `1.13.0.Final`
* Build project

## Deploy OCP on AWS
References to install an OpenShift cluster using the :
* [Welcome to Red Hat OpenShift Service on AWS (ROSA)](https://console.redhat.com/openshift/create/rosa/welcome)
* [Deploy the cluster](https://www.rosaworkshop.io/rosa/2-deploy/)

Example of commands executed:
```shell
rosa create account-roles --mode auto --yes
rosa create cluster --interactive --sts
```
Example of manual configuration:
```text
? Cluster name: kogito-ocp
? OpenShift version: 4.9.4
I: Using arn:aws:iam::793718559102:role/ManagedOpenShift-Installer-Role for the Installer role
I: Using arn:aws:iam::793718559102:role/ManagedOpenShift-ControlPlane-Role for the ControlPlane role
I: Using arn:aws:iam::793718559102:role/ManagedOpenShift-Worker-Role for the Worker role
I: Using arn:aws:iam::793718559102:role/ManagedOpenShift-Support-Role for the Support role
? External ID (optional):
? Operator roles prefix: kogito-ocp-q5p0
? Multiple availability zones (optional): No
? AWS region: eu-central-1
? PrivateLink cluster (optional): No
? Install into an existing VPC (optional): No
? Enable Customer Managed key (optional): No
? Compute nodes instance type (optional): c5.4xlarge
? Enable autoscaling (optional): No
? Compute nodes: 4
? Machine CIDR: 10.0.0.0/16
? Service CIDR: 172.30.0.0/16
? Pod CIDR: 10.128.0.0/14
? Host prefix: 23
? Disable Workload monitoring (optional): No
```
Further configurations are needed:
```shell
rosa create operator-roles --mode manual --cluster kogito-ocp
rosa create oidc-provider --mode manual --cluster kogito-ocp
```
**Note***: Run each of the aws commands presented in the above command outputs

### Access OCP cluster
Use this command to expose the URL of the newly created OCP cluster:

```shell
rosa describe cluster -c kogito-ocp | grep Console
Console URL:                https://console-openshift-console.apps.kogito-ocp.hib9.p1.openshiftapps.com
```

To access the cluster, we need to create an admin account like `cluster-admin` (see [Accessing a ROSA cluster](https://docs.openshift.com/rosa/rosa_getting_started/rosa-accessing-cluster.html):
```shell
rosa create admin --cluster kogito-ocp
```
Then you can connect the `oc` client using the usual `oc login https://api.kogito-ocp.hib9.p1.openshiftapps.com:6443` command

## Deploy Kogito app and MongoDB on OCP
Requirements:
* OCP cluster created
* `oc` login executed on the target namespace `kogito-benchmark`

### Deploy MongoDB Operator
Follow the updated instructions to [Install the MongoDB operator](../test-envs/deploy-OCP/deploy-app/README.md#install-the-mongodb-operator)
**Note**: we are using the `main` branch of the operator repository because the previous one is no more compatible
with the latest OpenShift 4.9 release

## Deploy the MongoDB instance
Together with the standard deployment, we also provide an extended configuration [kogito-mongodb-withresources.yml](../test-envs/deploy-OCP/deploy-app/kogito-mongodb-withresources.yml)
with higher requirements and limits for the Mongo containers. Verify which one you want to deploy before running the following
commands:
```shell
cd test-envs/deploy-OCP/deploy-app
oc apply -f kogito-mongodb.yml
```

**Note**: compared to previous deplpoyments, we've made the following changes:
* DB name is `kogito_quarkus` instead og `kogito_dataindex`
* Password for `developer` user is `password` instead of `mypass`

#### Retrieve the Mongo connection URL
Use this command to retrieve the connection URL generated by the MOngoDB orperator for our instance:
```shell
oc get secret kogito-mongodb-admin-developer -o json | jq -r '.data | with_entries(.value |= @base64d)'
```
```yaml
{
"connectionString.standard": "mongodb://developer:password@kogito-mongodb-0.kogito-mongodb-svc.kogito-benchmark.svc.cluster.local:27017,kogito-mongodb-1.kogito-mongodb-svc.kogito-benchmark.svc.cluster.local:27017,kogito-mongodb-2.kogito-mongodb-svc.kogito-benchmark.svc.cluster.local:27017/admin?ssl=false",
"connectionString.standardSrv": "mongodb+srv://developer:password@kogito-mongodb-svc.kogito-benchmark.svc.cluster.local/admin?ssl=false",
"password": "password",
"username": "developer"
}
```
The `connectionString.standardSrv` field can be used in the application deployment, see [kogito-app.yaml](../test-envs/deploy-OCP/deploy-app/kogito-app.yaml):
```yaml
              valueFrom:
                secretKeyRef:
                  name: kogito-mongodb-admin-developer
                  key: connectionString.standardSrv
```

### Build Kogito app
Some changes are needed to integrate the latest version, until it is released, mainluy need to add following repos to ythe build descriptor:
* `https://repository.jboss.org/nexus/content/repositories/jboss_releases_staging_profile-18485/`
* `https://repository.jboss.org/nexus/content/repositories/jboss_releases_staging_profile-18486/`
The Maven descriptor also includes a new dependency on `quarkus-container-image-jib` to generate the docker image
(see [Container images](https://quarkus.io/guides/container-image))

Build and generate the local image, hen push on quay:
```shell
cd test-apps/process-quarkus-example
mvn -Dquarkus.profile=mongo -P mongo clean package -Dquarkus.container-image.build=true

docker tag dmartino/process-quarkus-example:1.13.0.Final quay.io/dmartino/process-quarkus-example:1.13.0.Final
docker login quay.io
docker push quay.io/dmartino/process-quarkus-example:1.13.0.Final
```
Finally, go to the Quay.io repository and change the image visibility to `public`.

**Note**: some configurable properties have been added to the `mongo` profile, before launching the app we have to configure these 4 variables:
* quarkus.vertx.worker-pool-size=${WORKER_POOL_SIZE}
* quarkus.mongodb.min-pool-size=${MIN_POOL}
* quarkus.mongodb.max-pool-size=${MAX_POOL}
* quarkus.mongodb.connection-string=${MONGODB_URL}

### Deploy Kogito app on OCP
Verify the configuration of the given deployment [kogito-app.yaml](../test-envs/deploy-OCP/deploy-app/kogito-app.yaml) and
deploy on the cluster:
```shell
cd test-envs/deploy-OCP
oc apply -f kogito-app.yaml
```

### Build an deploy the Quarkus client
Follow this sample instructions to build the client image, deploy it on Quay.io and then on the OpenShift cluster:
```shell
cd test-clients/quarkus-client
mvn clean package -Dquarkus.container-image.build=true
docker tag dmartino/kogito-benchmark-client:1.0.0-SNAPSHOT quay.io/dmartino/kogito-benchmark-client:1
docker push quay.io/dmartino/kogito-benchmark-client:1
oc apply -f quarkus-client.yaml
```

Note that the given [quarkus-client.yaml](../test-clients/quarkus-client/quarkus-client.yaml) has configurable properties
lo locate the Kogito app and to define the `quarkus.vertx.worker-pool-size` property.

Verify that the Pod is connected to the Kogito app:
```shell
curl -X GET http://localhost:9090/benchmark/simple/20/100
```

## Test execution and report collection
The test implemented by [test.sh](./test.sh) does the following:
* Reads test configuration from [batch-template.json](./batch-template.json) and creates an udated version as `test-run-batch.json`
with values retrieved from the current OpenShift deployments
  * You can customize the template by adding your own comments in the `Notes` section or refer to relevant properties in the
  `ProcessProperties` section
* Runs the [run_and_collect_metrics.sh](./scripts/run_and_collect_metrics.sh) test execution for the configured number of 
`Tests.repeats`, and applies the given number of `Tests.replicas` and `Tests.users` at every run
* Replicas are reset to zero and then to the configured value only when the number of replicas change:
  * The purpose is to see how the previous executions affect the performance of any given run
* Before any actual test, the DB collection are cleaned up
* After the test completes, use the generated `test-run` folder to generate the report from the `kogito-1.13.0.Final`
branch of the [Report Generator](`https://github.com/RHEcosystemAppEng/kogito-benchmark-automation/tree/main/reportGenerator`)

Sample reports are available in the [sampleReports](./sampleReports) folder

### Fetching runtime metrics
This command returns the route of the Prometheus service on the cluster:
```shell
oc -n openshift-monitoring get routes | grep prometheus-k8s
```
This URL is used in the [metrics.sh](./scripts/metrics.sh) script to connect to the Promethues API service and query
for the metrics defined in the [prometheus](./prometheus) folder

The same API can be invoked from the command line as:
```shell
QUERY=`cat cpu_by_pod.txt` && curl -s --data-urlencode "query=$QUERY" \
'https://prometheus-k8s-openshift-monitoring.apps.kogito-ocp.hib9.p1.openshiftapps.com/api/v1/query' \
--header 'Authorization: Bearer sha256~j9n_91fsT5DceyucZy6GjbNs-uRp_eYGn_xhWYDWya8'
```

The token comes from:
```shell
oc whoami -t
```