- [Introduction](#introduction)
- [Mongo DB Sharding with Pre-split.](#mongo-db-sharding-with-pre-split)
    * [Process to pre-split data.](#process-to-pre-split-data)
- [References](#references)

# Introduction
This documentation will explain on how to split GUI Based shard key with Mongo DB into all the shards equally.

# Mongo DB Sharding with Pre-split.
We had a mongo DB sharded cluster to hold a collection with shard key as GUI Key generated by quarkus application. We would like to distribute the data among all the shards before inserting it rather than mongo DB doing rebalancing automatically. 

Overall idea is to split the GUI key range into number of shards available on the cluster. Each cluster is assigned with a chunk with one of the GUI key range. This will ensure to pre-split the data before inserting into the mongo DB collection.

Please follow this process before inserting any data into the collection and enabling sharding on the collection for better performance.

## Process to pre-split data.

**Step1:** Enabling sharding on the database & collection. 

```shell
//switch the database
use kogito_quarkus

//enable sharding on the database
sh.enableSharding("kogito_quarkus")
//Add index on the GUI Key ID. It is not the primary key column created by mongo.i.e., _id.
db.demo.simpleHT.ensureIndex({id: 1})
//enabling sharding on the collection with shard key as id.
sh.shardCollection("kogito_quarkus.demo.simpleHT",{"id":1})
//Disabling auto split and balancing to make sure our changes are working. We can enable them later.
sh.disableAutoSplit()
sh.stopBalancer()
//Check the status before going to step 1.
sh.status()
```

**Step2:** Add number of chunks same as the number of shards.  GUI key is the 16 bit one so we are diving the gui key into 4 ranges.

Below code is to create 4 chunks for 4 shards.
```shell
for ( var x=4; x < 16; x+=4){
  var prefix = "" + x.toString(16) + "0000000000000000000000000000000";
  db.adminCommand( { split : "kogito_quarkus.demo.simpleHT" , middle : { id : prefix } } );
  }
```

Below code is to create 8 chunks for 8 shards.
```shell
for ( var x=2; x < 16; x+=2){
  var prefix = "" + x.toString(16) + "0000000000000000000000000000000";
  db.adminCommand( { split : "kogito_quarkus.demo.simpleHT" , middle : { id : prefix } } );
  }
```

**Step3:** Now all the chunks are assigned to same shard as the primary shard. We need to move each chunk to the different shard by executing below script.

```shell
//switch to the config database
use config
var cursor = db.chunks.find({ ns: 'kogito_quarkus.demo.simpleHT'});
var shardIndex = 0;
cursor.forEach(function(d) {
print( "chunk: " + d.min.id );
//assuming shards name as kogito-sharded-mongo-0
print( "shardIndex: " + ("kogito-sharded-mongo-"+(shardIndex)) );
sh.moveChunk("kogito_quarkus.demo.simpleHT", { "id" : d.min.id }, ("kogito-sharded-mongo-"+(shardIndex)));
shardIndex = shardIndex + 1;
});
```

# References
* https://stackoverflow.com/questions/19672302/how-to-programmatically-pre-split-a-guid-based-shard-key-with-mongodb